{% extends 'base.html' %}

{% block title %}Order {{ order.id }} | GSP{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='styles/order.css') }}">
<script src="{{ url_for('static', filename='scripts/fileSize.js') }}" defer></script>
{% endblock %}

{% block body %}
<div class="order-box">
    {% with msg = get_flashed_messages() %}
        {% if msg: %}<div class="order-msg">{{ msg[0] }}</div>{% endif %}
    {% endwith %}

    <div class="order-service">
        {% set service = Service.query.filter_by(id=order.service_id).first() %}
        <h2>
            <b>Order For:</b>
            <a href="{{ url_for('service', id=order.service_id) }}" target="_blank">
                {{ service.title }}
                <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M6 6v2h8.59L5 17.59L6.41 19L16 9.41V18h2V6z"/>
                </svg>
            </a>
        </h2>
        {% set department = Department.query.filter_by(id=order.service_id).first() %}
        {% if department %}
            <h3>
                <a href="{{ url_for('department', id=department.id) }}" target="_blank">
                    {{ department.title }}
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M6 6v2h8.59L5 17.59L6.41 19L16 9.41V18h2V6z"/>
                    </svg>
                </a>
            </h3>
        {% endif %}
    </div>
    <p class="order-id"><b>Reference Number:</b> <span>{{ order.id }}</span></p>
    <p class="order-id order-user-id" style="margin-bottom: 25px;">
        <b>User National ID:</b>
        <a href="{{ url_for('profile', id=order.user_id) }}" target="_blank">
            <span>{{ order.user_id }}</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
                <path fill="currentColor" d="M6 6v2h8.59L5 17.59L6.41 19L16 9.41V18h2V6z"/>
            </svg>
        </a>
    </p>

    <p>
        <b>Order at:</b>
        {{ naturaltime(order.start_date) }}
        -
        {% set time = strptime(str(order.start_date), "%Y-%m-%d %H:%M:%S") %}
        {{ time.strftime("%d %b, %Y at %I:%M %p") }}
    </p>
    {% if order.is_done == True %}
        <p>
            <b>Done at:</b>
            {{ naturaltime(order.end_date) }}
            -
            {% set time = strptime(str(order.end_date), "%Y-%m-%d %H:%M:%S") %}
            {{ time.strftime("%d %b, %Y at %I:%M %p") }}
        </p>
        <p><b>Status:</b> <span class="status-done">Finished</span></p>
    {% else  %}
        <p><b>Status:</b> <span class="status-active">Active</span></p>
    {% endif %}

    {% if order.details %}
        <p class="order-details">
            <b>Details Included:</b>
            <br>
            {{ order.details }}
        </p>
    {% endif %}

    {% if order.file_paths %}
    <p class="order-files">
        <b>Files Included:</b>
        <br>
        <br>
        {% for file in order.file_paths.split(',') %}
            {% if file.endswith(('.jpg', '.jpeg', '.png', '.gif', '.ico', 'avif', 'webp', 'bmp', 'tiff')) %}
                <img src="{{ url_for('serve_file', filename=file) }}" class="order-image">
                <a href="{{ url_for('serve_file', filename=file) }}" download>
                    <button class="download-btn">
                        <svg class="download-svg" viewBox="0 0 384 512" height="1em" xmlns="http://www.w3.org/2000/svg">
                            <path d="M169.4 470.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 370.8 224 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 306.7L54.6 265.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z">
                            </path>
                        </svg>
                        <span class="download-icon"></span>
                        <span class="tooltip" data-file="{{ url_for('serve_file', filename=file) }}"></span>
                    </button>
                </a>
            {% elif file.endswith(('.pdf', '.docx', '.xlxs')) %}
                <img src="{{ url_for('static', filename='images/placeholders/doc_file.png') }}" class="order-image">
                <a href="{{ url_for('serve_file', filename=file) }}" download>
                    <button class="download-btn">
                        <svg class="download-svg" viewBox="0 0 384 512" height="1em" xmlns="http://www.w3.org/2000/svg">
                            <path d="M169.4 470.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 370.8 224 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 306.7L54.6 265.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z">
                            </path>
                        </svg>
                        <span class="download-icon"></span>
                        <span class="tooltip" data-file="{{ url_for('serve_file', filename=file) }}"></span>
                    </button>
                </a>
            {% elif file.endswith(('.txt', '.rtf', 'csv', '.json', '.html', '.md')) %}
                <img src="{{ url_for('static', filename='images/placeholders/text_file.png') }}" class="order-image">
                <a href="{{ url_for('serve_file', filename=file) }}" download>
                    <button class="download-btn">
                        <svg class="download-svg" viewBox="0 0 384 512" height="1em" xmlns="http://www.w3.org/2000/svg">
                            <path d="M169.4 470.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 370.8 224 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 306.7L54.6 265.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z">
                            </path>
                        </svg>
                        <span class="download-icon"></span>
                        <span class="tooltip" data-file="{{ url_for('serve_file', filename=file) }}"></span>
                    </button>
                </a>
            {% elif file.endswith('.mp4') %}
                <img src="{{ url_for('static', filename='images/placeholders/video_file.png') }}" class="order-image">
                <a href="{{ url_for('serve_file', filename=file) }}" download>
                    <button class="download-btn">
                        <svg class="download-svg" viewBox="0 0 384 512" height="1em" xmlns="http://www.w3.org/2000/svg">
                            <path d="M169.4 470.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 370.8 224 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 306.7L54.6 265.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z">
                            </path>
                        </svg>
                        <span class="download-icon"></span>
                        <span class="tooltip" data-file="{{ url_for('serve_file', filename=file) }}"></span>
                    </button>
                </a>
            {% elif file.endswith('.mp3') %}
                <img src="{{ url_for('static', filename='images/placeholders/audio_file.png') }}" class="order-image">
                <a href="{{ url_for('serve_file', filename=file) }}" download>
                    <button class="download-btn">
                        <svg class="download-svg" viewBox="0 0 384 512" height="1em" xmlns="http://www.w3.org/2000/svg">
                            <path d="M169.4 470.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 370.8 224 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 306.7L54.6 265.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z">
                            </path>
                        </svg>
                        <span class="download-icon"></span>
                        <span class="tooltip" data-file="{{ url_for('serve_file', filename=file) }}"></span>
                    </button>
                </a>
            {% elif file.endswith(('.zip', '.rar')) %}
                <img src="{{ url_for('static', filename='images/placeholders/comp_file.png') }}" class="order-image">
                <a href="{{ url_for('serve_file', filename=file) }}" download>
                    <button class="download-btn">
                        <svg class="download-svg" viewBox="0 0 384 512" height="1em" xmlns="http://www.w3.org/2000/svg">
                            <path d="M169.4 470.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 370.8 224 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 306.7L54.6 265.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z">
                            </path>
                        </svg>
                        <span class="download-icon"></span>
                        <span class="tooltip" data-file="{{ url_for('serve_file', filename=file) }}"></span>
                    </button>
                </a>
            {% else %}
                <img src="{{ url_for('static', filename='images/placeholders/generic_file.png') }}" class="order-image">
                <a href="{{ url_for('serve_file', filename=file) }}" download>
                    <button class="download-btn">
                        <svg class="download-svg" viewBox="0 0 384 512" height="1em" xmlns="http://www.w3.org/2000/svg">
                            <path d="M169.4 470.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 370.8 224 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 306.7L54.6 265.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z">
                            </path>
                        </svg>
                        <span class="download-icon"></span>
                        <span class="tooltip" data-file="{{ url_for('serve_file', filename=file) }}"></span>
                    </button>
                </a>
            {% endif %}

            {{ file.split('_', maxsplit=1)[-1] }}
            <br>
        {% endfor %}
    </p>
    {% endif %}

    {% if order.is_done == False %}
        <form action="{{ url_for('user_order', id=order.id) }}" method="post" class="first-form">
            <input type="hidden" name="action" value="finish_order">
            <input class="form-btn" type="submit" value="Finish Order">
        </form>
    {% endif %}
    <form action="{{ url_for('user_order', id=order.id) }}" method="post"
        onsubmit="return confirm('Are you sure you want to delete this order?');">
        <input type="hidden" name="action" value="delete_order">
        <input class="form-btn danger" type="submit" value="Delete Order">
    </form>
</div>
{% endblock %}